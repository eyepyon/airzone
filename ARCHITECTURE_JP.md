# Airzone アーキテクチャ

## システム概要

Airzoneは、WiFi接続をトリガーとしてNFTを自動配布し、NFT保有者限定の商品販売を行うプラットフォームです。

### 主要コンポーネント

```
┌─────────────────────────────────────────────────────────┐
│                    ユーザー                              │
│  (ブラウザ / Xaman Walletアプリ)                        │
└────────────┬────────────────────────────────────────────┘
             │
             │ HTTPS
             ▼
┌─────────────────────────────────────────────────────────┐
│                  Apache Webサーバー                      │
│  - SSL/TLS終端                                          │
│  - リバースプロキシ                                      │
│  - 静的ファイル配信                                      │
└────────┬───────────────────────────┬────────────────────┘
         │                           │
         │ Next.js                   │ Laravel
         ▼                           ▼
┌──────────────────┐        ┌──────────────────┐
│  フロントエンド   │        │   管理パネル      │
│  (Next.js 14)    │        │  (Laravel 10)    │
│  - React         │        │  - Blade         │
│  - TypeScript    │        │  - Tailwind CSS  │
│  - Tailwind CSS  │        │  - 効果測定      │
└────────┬─────────┘        └────────┬─────────┘
         │                           │
         │ REST API                  │ DB直接アクセス
         ▼                           ▼
┌─────────────────────────────────────────────────────────┐
│                  バックエンドAPI                         │
│                  (Flask 3.0)                            │
│  ┌────────────────────────────────────────────────────┐ │
│  │  Routes (Blueprints)                               │ │
│  │  - auth: Google OAuth認証                          │ │
│  │  - nft: NFT発行管理                                │ │
│  │  - product: 商品管理                               │ │
│  │  - order: 注文処理                                 │ │
│  │  - payment: Stripe決済                             │ │
│  │  - wallet: ウォレット接続                          │ │
│  │  - download: ダウンロード追跡                      │ │
│  └────────────────────────────────────────────────────┘ │
│  ┌────────────────────────────────────────────────────┐ │
│  │  Services (ビジネスロジック)                       │ │
│  │  - AuthService: 認証・JWT管理                      │ │
│  │  - NFTService: NFT発行・管理                       │ │
│  │  - WalletService: ウォレット生成・管理             │ │
│  │  - ProductService: 商品CRUD                        │ │
│  │  - OrderService: 注文処理                          │ │
│  └────────────────────────────────────────────────────┘ │
│  ┌────────────────────────────────────────────────────┐ │
│  │  Clients (外部サービス)                            │ │
│  │  - XRPLClient: XRPL統合                            │ │
│  │  - StripeClient: 決済処理                          │ │
│  │  - GoogleAuthClient: OAuth認証                     │ │
│  └────────────────────────────────────────────────────┘ │
└────────┬───────────────────────────┬────────────────────┘
         │                           │
         │ SQLAlchemy                │ xrpl-py
         ▼                           ▼
┌──────────────────┐        ┌──────────────────┐
│   MySQL 8.0      │        │  XRPL Network    │
│  - users         │        │  (Testnet/Main)  │
│  - wallets       │        │  - NFT発行       │
│  - nft_mints     │        │  - 残高確認      │
│  - products      │        │  - トランザクション│
│  - orders        │        └──────────────────┘
│  - user_activities│
└──────────────────┘

外部サービス:
┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐
│  XRPL Blockchain │  │  Stripe API      │  │  Google OAuth    │
│  (Testnet)       │  │  (決済)          │  │  (認証)          │
└──────────────────┘  └──────────────────┘  └──────────────────┘
```

## 技術スタック

### フロントエンド
- **フレームワーク**: Next.js 14 (App Router)
- **言語**: TypeScript
- **スタイリング**: Tailwind CSS
- **状態管理**: Zustand
- **ブロックチェーン**: XRPL、Xaman Wallet SDK
- **決済**: @stripe/react-stripe-js
- **HTTP クライアント**: Fetch API

### バックエンド
- **フレームワーク**: Flask 3.0
- **言語**: Python 3.11+
- **ORM**: SQLAlchemy 2.0
- **認証**: Flask-JWT-Extended
- **データベース**: MySQL 8.0
- **ブロックチェーン**: xrpl-py
- **決済**: Stripe Python SDK
- **タスクキュー**: カスタム実装

### 管理パネル
- **フレームワーク**: Laravel 10
- **言語**: PHP 8.1+
- **テンプレート**: Blade
- **スタイリング**: Tailwind CSS
- **データベース**: MySQL 8.0（共有）

### ブロックチェーン
- **プラットフォーム**: XRPL (XRP Ledger)
- **SDK**: xrpl-py (Python XRPL SDK)
- **ネットワーク**: Testnet / Mainnet
- **ウォレット**: 自動生成 / Xaman Wallet

### インフラ
- **Webサーバー**: Apache 2.4
- **SSL/TLS**: Let's Encrypt
- **プロセス管理**: systemd
- **ログ**: Python logging / Laravel log

## データフロー

### 1. ユーザー登録・認証

```
ユーザー
  ↓ 1. Google OAuth開始
フロントエンド
  ↓ 2. Google認証画面へリダイレクト
Google OAuth
  ↓ 3. IDトークン取得
フロントエンド
  ↓ 4. POST /api/v1/auth/google (IDトークン)
バックエンド
  ├─ 5. IDトークン検証
  ├─ 6. ユーザー作成/取得
  ├─ 7. XRPLウォレット自動生成
  ├─ 8. JWT発行
  └─ 9. ログインアクティビティ記録
  ↓ 10. JWTトークン返却
フロントエンド
  ↓ 11. トークン保存
ユーザー（ログイン完了）
```

### 2. NFT発行

```
ユーザー
  ↓ 1. WiFi接続 / 手動リクエスト
フロントエンド
  ↓ 2. POST /api/v1/nfts/mint
バックエンド
  ├─ 3. JWT認証
  ├─ 4. ユーザーウォレット取得
  ├─ 5. NFT発行タスク作成
  └─ 6. タスクIDを返却
  ↓
TaskManager
  ├─ 7. バックグラウンドで実行
  ├─ 8. NFTメタデータ準備
  └─ 9. XRPLClientを呼び出し
  ↓
XRPLClient
  ├─ 10. スポンサーウォレットで署名
  ├─ 11. XRPL Networkにトランザクション送信
  └─ 12. トランザクション結果取得（3-5秒）
  ↓
TaskManager
  ├─ 13. NFT発行ステータス更新
  └─ 14. データベースに記録
  ↓
ユーザー（NFT受け取り完了）
```

### 3. 商品購入

```
ユーザー
  ↓ 1. 商品選択
フロントエンド
  ↓ 2. GET /api/v1/products/{id}
バックエンド
  ├─ 3. 商品情報取得
  ├─ 4. NFT要件確認
  └─ 5. 商品情報返却
  ↓
フロントエンド
  ↓ 6. POST /api/v1/orders
バックエンド
  ├─ 7. JWT認証
  ├─ 8. NFT保有確認
  ├─ 9. 在庫確認
  ├─ 10. 注文作成
  ├─ 11. Stripe決済セッション作成
  └─ 12. 購入アクティビティ記録
  ↓ 13. 決済URL返却
フロントエンド
  ↓ 14. Stripe決済画面へリダイレクト
Stripe
  ↓ 15. 決済処理
  ↓ 16. Webhook通知
バックエンド
  ├─ 17. 決済確認
  ├─ 18. 注文ステータス更新
  └─ 19. 在庫減少
  ↓
ユーザー（購入完了）
```

## セキュリティ

### 認証・認可
- **Google OAuth 2.0**: ユーザー認証
- **JWT**: APIアクセストークン（1時間有効）
- **リフレッシュトークン**: 30日間有効
- **ミドルウェア**: 全保護エンドポイントで認証チェック

### データ保護
- **ウォレット秘密鍵**: Fernet対称暗号化
- **環境変数**: 機密情報は.envで管理
- **HTTPS**: 全通信をTLS 1.3で暗号化
- **CORS**: 許可されたオリジンのみアクセス可能

### トランザクション検証
- **署名検証**: XRPL SDK で自動検証
- **手数料制限**: 約 0.00001 XRP（固定）
- **エラーハンドリング**: リトライロジック

### レート制限
- **デフォルト**: 10,000リクエスト/時間
- **カスタマイズ可能**: エンドポイント毎に設定

## スケーラビリティ

### 水平スケーリング
- **ステートレスAPI**: 複数インスタンス展開可能
- **ロードバランサー**: Apache/Nginxで負荷分散
- **データベース**: レプリケーション対応

### 非同期処理
- **TaskManager**: バックグラウンドタスク実行
- **NFT発行**: 非同期で処理（ユーザー待機不要）
- **リトライ**: 失敗時の自動再試行

### キャッシング
- **静的ファイル**: CDN配信
- **APIレスポンス**: 適切なCache-Controlヘッダー
- **データベース**: クエリ最適化

## 監視・ログ

### ログ
- **バックエンド**: `backend/logs/app.log`
- **管理パネル**: `admin/storage/logs/laravel.log`
- **Apache**: `/var/log/apache2/`

### メトリクス
- **DAU/MAU**: ユーザーアクティビティから計算
- **ダウンロード数**: user_activitiesテーブル
- **エンゲージメント率**: DAU/MAU比率
- **トランザクション成功率**: NFT発行ログ

### アラート
- **スポンサーウォレット残高**: 閾値以下で通知
- **エラー率**: 異常検知
- **レスポンスタイム**: パフォーマンス監視

## デプロイメント

### 環境
- **開発**: localhost
- **ステージング**: テストサーバー
- **本番**: 本番サーバー

### CI/CD
- **テスト**: 自動テスト実行
- **ビルド**: 依存関係インストール
- **デプロイ**: systemdサービス再起動

## 主な特徴

- **スポンサードトランザクション**: ユーザーは手数料不要で NFT を受け取れる
- **自動ウォレット生成**: ユーザー登録時に XRPL ウォレットを自動作成
- **Xaman Wallet対応**: ユーザーが自分のウォレットを接続可能
- **NFT ゲート EC**: NFT 保有者限定商品の販売
- **非同期処理**: バックグラウンドタスクで NFT 発行
- **効果測定**: DAU/MAU/ダウンロード数の自動計測

## 関連ドキュメント

- [セットアップガイド](docs/SETUP_GUIDE_JP.md)
- [XRPL統合](docs/xrpl-integration.md)
- [Xaman Wallet統合](docs/xaman-wallet-integration.md)
- [API リファレンス](backend/API_REFERENCE.md)
