# ============================================================================
# Airzone Apache Configuration
# ============================================================================
#
# Installation Instructions:
# 1. Copy this file to /etc/apache2/sites-available/airzone.conf
# 2. Enable required modules: sudo a2enmod ssl rewrite headers proxy proxy_http wsgi
# 3. Enable site: sudo a2ensite airzone.conf
# 4. Test config: sudo apache2ctl configtest
# 5. Reload Apache: sudo systemctl reload apache2
#
# ============================================================================

# HTTP Virtual Host - Redirect to HTTPS
<VirtualHost *:80>
    ServerName airz.one
    ServerAlias www.airz.one
    ServerAdmin admin@airz.one
    
    # Redirect all HTTP traffic to HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}$1 [R=301,L]
    
    # Logging
    ErrorLog ${APACHE_LOG_DIR}/airzone_http_error.log
    CustomLog ${APACHE_LOG_DIR}/airzone_http_access.log combined
</VirtualHost>

# HTTPS Virtual Host - Main Application
<VirtualHost *:443>
    ServerName airz.one
    ServerAlias www.airz.one
    ServerAdmin admin@airz.one
    
    # Document Root (for static files if needed)
    DocumentRoot /var/www/airzone/public
    
    # ========================================================================
    # SSL/TLS Configuration
    # ========================================================================
    
    SSLEngine on
    
    # SSL Certificate files (managed by certbot)
    SSLCertificateFile /etc/letsencrypt/live/airz.one/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/airz.one/privkey.pem
    Include /etc/letsencrypt/options-ssl-apache.conf
    
    # Modern SSL/TLS configuration
    SSLProtocol all -SSLv2 -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    SSLHonorCipherOrder off
    SSLSessionTickets off
    
    # ========================================================================
    # Security Headers
    # ========================================================================
    
    # HTTP Strict Transport Security (HSTS)
    # Tells browsers to only use HTTPS for the next year
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    
    # Prevent clickjacking attacks
    Header always set X-Frame-Options "SAMEORIGIN"
    
    # Prevent MIME type sniffing
    Header always set X-Content-Type-Options "nosniff"
    
    # Enable XSS protection
    Header always set X-XSS-Protection "1; mode=block"
    
    # Referrer policy
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Content Security Policy (adjust as needed)
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://accounts.google.com https://js.stripe.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https://api.stripe.com https://fullnode.testnet.sui.io https://fullnode.mainnet.sui.io; frame-src https://accounts.google.com https://js.stripe.com;"
    
    # Permissions Policy (formerly Feature-Policy)
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"
    
    # ========================================================================
    # Backend API - Flask Application (mod_wsgi)
    # ========================================================================
    
    # WSGI Configuration
    WSGIDaemonProcess airzone_backend \
        python-home=/var/www/airzone/backend/venv \
        python-path=/var/www/airzone/backend \
        processes=4 \
        threads=2 \
        display-name=%{GROUP} \
        lang='en_US.UTF-8' \
        locale='en_US.UTF-8'
    
    WSGIProcessGroup airzone_backend
    WSGIScriptAlias /api /var/www/airzone/backend/wsgi.py
    
    # WSGI application directory permissions
    <Directory /var/www/airzone/backend>
        WSGIApplicationGroup %{GLOBAL}
        WSGIScriptReloading On
        Require all granted
        
        # Prevent access to .env and sensitive files
        <FilesMatch "^\.env">
            Require all denied
        </FilesMatch>
    </Directory>
    
    # Backend static files (if any)
    Alias /api/static /var/www/airzone/backend/static
    <Directory /var/www/airzone/backend/static>
        Require all granted
        Options -Indexes
    </Directory>
    
    # ========================================================================
    # Frontend - Next.js Application (Reverse Proxy)
    # ========================================================================
    
    # Preserve the original Host header
    ProxyPreserveHost On
    
    # Don't proxy API requests (handled by WSGI above)
    ProxyPass /api !
    
    # Proxy all other requests to Next.js
    ProxyPass / http://localhost:3000/
    ProxyPassReverse / http://localhost:3000/
    
    # WebSocket support (for Next.js hot reload in development)
    # RewriteEngine On
    # RewriteCond %{HTTP:Upgrade} =websocket [NC]
    # RewriteRule /(.*)           ws://localhost:3000/$1 [P,L]
    
    # ========================================================================
    # Static File Caching
    # ========================================================================
    
    <IfModule mod_expires.c>
        ExpiresActive On
        
        # Images
        ExpiresByType image/jpeg "access plus 1 year"
        ExpiresByType image/png "access plus 1 year"
        ExpiresByType image/gif "access plus 1 year"
        ExpiresByType image/svg+xml "access plus 1 year"
        ExpiresByType image/webp "access plus 1 year"
        
        # CSS and JavaScript
        ExpiresByType text/css "access plus 1 month"
        ExpiresByType application/javascript "access plus 1 month"
        
        # Fonts
        ExpiresByType font/woff2 "access plus 1 year"
        ExpiresByType font/woff "access plus 1 year"
        ExpiresByType font/ttf "access plus 1 year"
        
        # Default
        ExpiresDefault "access plus 1 week"
    </IfModule>
    
    # ========================================================================
    # Compression
    # ========================================================================
    
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css
        AddOutputFilterByType DEFLATE application/javascript application/json
        AddOutputFilterByType DEFLATE image/svg+xml
    </IfModule>
    
    # ========================================================================
    # Logging
    # ========================================================================
    
    ErrorLog ${APACHE_LOG_DIR}/airzone_error.log
    CustomLog ${APACHE_LOG_DIR}/airzone_access.log combined
    
    # Log level: debug, info, notice, warn, error, crit, alert, emerg
    LogLevel warn
    
    # ========================================================================
    # Rate Limiting (Optional - requires mod_ratelimit)
    # ========================================================================
    
    # <Location /api>
    #     SetOutputFilter RATE_LIMIT
    #     SetEnv rate-limit 400
    # </Location>
    
</VirtualHost>

# ============================================================================
# Additional Security Settings
# ============================================================================

# Disable server signature
ServerSignature Off
ServerTokens Prod

# Disable directory listing
<Directory />
    Options -Indexes
    AllowOverride None
    Require all denied
</Directory>

# ============================================================================
# SSL Session Cache (for performance)
# ============================================================================

<IfModule mod_ssl.c>
    SSLSessionCache shmcb:${APACHE_RUN_DIR}/ssl_scache(512000)
    SSLSessionCacheTimeout 300
    SSLStaplingCache shmcb:${APACHE_RUN_DIR}/ssl_stapling(128000)
</IfModule>
